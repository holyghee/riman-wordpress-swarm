name: Deploy to Live Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    name: Deploy to All-Inkl Server
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: Install sshpass
      run: sudo apt-get update && sudo apt-get install -y sshpass

    - name: Deploy Files to Live Server
      run: |
        # Deploy RIMAN Video Compressor Plugin
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no -r wp-content/plugins/riman-video-compressor/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH }}/wp-content/plugins/

        # Deploy Updated RIMAN Blocks Files
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no wp-content/plugins/riman-blocks/assets/hero-responsive-video.js ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH }}/wp-content/plugins/riman-blocks/assets/
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no wp-content/plugins/riman-blocks/assets/cover-lazy-video.js ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH }}/wp-content/plugins/riman-blocks/assets/
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no wp-content/plugins/riman-blocks/assets/service-cards-mobile-slider.js ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH }}/wp-content/plugins/riman-blocks/assets/
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no wp-content/plugins/riman-blocks/assets/service-cards-mobile-slider.css ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH }}/wp-content/plugins/riman-blocks/assets/
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no wp-content/plugins/riman-blocks/assets/category-hero-slider.js ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH }}/wp-content/plugins/riman-blocks/assets/
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no wp-content/plugins/riman-blocks/blocks/riman-page-hero.php ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH }}/wp-content/plugins/riman-blocks/blocks/
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no wp-content/plugins/riman-blocks/blocks/service-cards.php ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH }}/wp-content/plugins/riman-blocks/blocks/
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no wp-content/plugins/riman-blocks/blocks/category-hero-slider.php ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH }}/wp-content/plugins/riman-blocks/blocks/
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -o StrictHostKeyChecking=no wp-content/plugins/riman-blocks/includes/cover-video-lazy.php ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.REMOTE_PATH }}/wp-content/plugins/riman-blocks/includes/

    - name: Check FFmpeg and Plugin Status
      run: |
        sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          cd ${{ secrets.REMOTE_PATH }} &&
          echo '=== Checking FFmpeg ===' &&
          which ffmpeg || echo 'FFmpeg not found' &&
          echo '=== Plugin Files Deployed ===' &&
          ls -la wp-content/plugins/riman-video-compressor/ &&
          echo '=== RIMAN Blocks Updated ===' &&
          ls -la wp-content/plugins/riman-blocks/assets/hero-responsive-video.js
        "

    - name: Deployment Complete
      run: |
        echo "ðŸš€ Deployment completed successfully!"
        echo "ðŸ“± Mobile video optimization system deployed to live server"
        echo "ðŸ”§ Next steps:"
        echo "   1. Activate RIMAN Video Compressor plugin in WordPress admin"
        echo "   2. Run video compression: /wp-admin/upload.php?page=riman-video-compressor"
        echo "   3. Test mobile videos on live site"